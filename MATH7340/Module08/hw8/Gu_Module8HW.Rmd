---
title: "Math7340 HW8"
author: "Chengbo Gu"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ALL)
library(lmtest)
```
### Problem 1 (40 points)

##### On the ALL data set, consider the ANOVA on the gene with the probe “109_at” expression values on B-cell patients in 5 groups: B, B1, B2, B3 and B4.
##### (a) Conduct the one-way ANOVA. Do the disease stages affect the mean gene expression value?

```{r}
data(ALL)
ALLBgroups <- ALL[,ALL$BT %in% c("B", "B1", "B2", "B3", "B4")]
y <- exprs(ALLBgroups)["109_at",]
anova( lm( y ~ ALLBgroups$BT ) )
```


##### (b) From the linear model fits, find the mean gene expression value among B3 patients.

```{r}
summary( lm( y ~ ALLBgroups$BT ) )
```

##### (c) Which group’s mean gene expression value is different from that of group B?

```{r}
pairwise.t.test(y, ALLBgroups$BT)
```

##### (d) Use the pairwise comparisons at FDR=0.05 to find which group means are different. What is your conclusion?

```{r}
pairwise.t.test(y,ALLBgroups$BT, p.adjust.method='fdr')
```

##### (e) Check the ANOVA model assumptions with diagnostic tests? Do we need to apply robust ANOVA tests here? If yes, apply the appropriate tests and state your conclusion.
```{r}
shapiro.test( residuals( lm( y ~ ALLBgroups$BT )))
bptest( lm( y ~ ALLBgroups$BT ), studentize = FALSE)
```

### Problem 2 (20 points)

##### Apply the nonparametric Kruskal-Wallis tests for every gene on the B-cell ALL patients in stage B, B1, B2, B3, B4 from the ALL data. (Hint: use the apply() function.)

##### (a) Use FDR adjustments at 0.05 level. How many genes are expressed differently in some of the groups?

```{r}
rm(list=ls())
data(ALL)
ALLBgroups <- ALL[,ALL$BT %in% c("B", "B1", "B2", "B3", "B4")]
y <- exprs(ALLBgroups)
p.values <- apply(y, 1, function(x) kruskal.test(x ~ ALLBgroups$BT)$p.value)
sum(p.values < 0.05)
```


##### (b) Find the probe names for the top five genes with smallest p-values.

```{r}
rownames(exprs(ALLBgroups))[order(p.values)][1:3]
```

### Problem 3 (20 points)

##### On the ALL data set, we consider the ANOVA on the gene with the probe “38555_at” expression values on two factors. The first factor is the disease stages: B1, B2, B3 and B4 (we only take patients from those four stages). The second factor is the gender of the patient (stored in the variable ALL$sex).

##### (a) Conduct the appropriate ANOVA analysis. Does any of the two factors affects the gene expression values? Are there interaction between the two factors?

```{r}
rm(list=ls())
data(ALL)
ALLBs <- ALL[,which(ALL$BT %in% c("B1","B2","B3","B4"), ALL$sex %in% c("F", "M"))]
y <- exprs(ALLBs)["38555_at",]
Bcell <- ALLBs$BT
sex <- ALLBs$sex
anova( lm( y ~ Bcell*sex ) )
```

##### (b) Check the ANOVA model assumption with diagnostic tests? Are any of the assumptions violated?
```{r}
shapiro.test( residuals( lm( y ~ Bcell + sex )))

bptest(lm(y ~ Bcell + sex), studentize = FALSE)
```


### Problem 4 (20 points)

##### We wish to conduct a permutation test for ANOVA on $(y_{1},...,y_{N})$, with the group indentifiers stored in the vector 'group'. We wish to use $\frac{1}{g-1}\sum_{j=1}^{g}(\hat\mu_{j}-\hat\mu)^2$ as the test statistic. Here $\hat\mu_{j}$ is the j-th group sample mean, and $\hat\mu=\frac{1}{g}\sum_{j=1}^{g}\hat\mu_{j}$.

##### (a) Program this permutation test in R.

##### (b) Run this permutation test on the Ets2 repressor gene 1242_at on the patients in stage B1, B2 and B3 from the ALL data set.

```{r}
rm(list=ls())
data(ALL)
ALLB123 <- ALL[,ALL$BT %in% c("B1","B2","B3")]
data<- exprs(ALLB123)["1242_at",]
group<-ALLB123$BT[,drop=T]
n <- length(data)
estimatedMean <- mean(by(data, group, mean))

T.obs <- sum( (by(data, group, mean) - estimatedMean) ^ 2) / 2

n.perm <- 2000
T.perm <- rep(NA, n.perm)
for(i in 1:n.perm) {
  data.perm <- sample(data, n, replace=F) #permute data
  estimatedMean <- mean(by(data.perm, group, mean))
  T.perm[i] <- sum( (by(data.perm, group, mean) - estimatedMean) ^ 2) / 2#Permuted statistic
}
mean(T.perm>=T.obs) #p-value
```


```{r}
data(ALL,package="ALL");library(ALL)
ALLB123 <- ALL[,ALL$BT %in% c("B1","B2","B3")] 
data<- exprs(ALLB123)["1866_g_at",] #gene 1866_g_at expression values
group<-ALLB123$BT[,drop=T] #drop unused levels, keep only B1,B2,B3
n<-length(data) #sample size n
T.obs<- anova(lm(data~group))$F[1] #Observed statistic = F-statistic
n.perm=2000 # we will do 2000 permutations
T.perm = rep(NA, n.perm) #A vector to save permutated statistic
for(i in 1:n.perm) {
data.perm = sample(data, n, replace=F) #permute data
T.perm[i] = anova(lm(data.perm~group))$F[1] #Permuted statistic
}
mean(T.perm>=T.obs)
```